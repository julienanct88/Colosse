import { useState, useEffect, useCallback, useRef } from "react";

// â”€â”€â”€ WAKE LOCK (screen stays on) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function useWakeLock(enabled) {
  const wakeLockRef = useRef(null);
  useEffect(() => {
    if (!enabled || !("wakeLock" in navigator)) return;
    let active = true;
    const request = async () => {
      try {
        wakeLockRef.current = await navigator.wakeLock.request("screen");
        wakeLockRef.current.addEventListener("release", () => {
          if (active) request();
        });
      } catch {}
    };
    request();
    const onVisibility = () => {
      if (document.visibilityState === "visible" && active) request();
    };
    document.addEventListener("visibilitychange", onVisibility);
    return () => {
      active = false;
      document.removeEventListener("visibilitychange", onVisibility);
      if (wakeLockRef.current) {
        wakeLockRef.current.release().catch(() => {});
      }
    };
  }, [enabled]);
}

// â”€â”€â”€ REST TIMER DEFAULTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const REST_PRESETS = [60, 90, 120, 150, 180];

// â”€â”€â”€ PHASE DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const phases = [
  { week: 1, phase: "RÃ©activation", color: "#F59E0B", date: "29 jan" },
  { week: 2, phase: "RÃ©activation", color: "#F59E0B", date: "5 fÃ©v" },
  { week: 3, phase: "RÃ©activation", color: "#F59E0B", date: "12 fÃ©v" },
  { week: 4, phase: "Hypertrophie", color: "#EF4444", date: "19 fÃ©v" },
  { week: 5, phase: "Hypertrophie", color: "#EF4444", date: "26 fÃ©v" },
  { week: 6, phase: "Hypertrophie", color: "#EF4444", date: "5 mars" },
  { week: 7, phase: "Consolidation", color: "#8B5CF6", date: "12 mars" },
  { week: 8, phase: "Consolidation", color: "#8B5CF6", date: "19 mars" },
  { week: 9, phase: "Maturation", color: "#10B981", date: "26 mars" },
  { week: 10, phase: "Maturation", color: "#10B981", date: "2 avr" },
  { week: 11, phase: "Maturation", color: "#10B981", date: "9 avr" },
  { week: 12, phase: "RÃ©sultat", color: "#3B82F6", date: "16 avr" },
];

// â”€â”€â”€ BICEPS PROJECTION (from your doc) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const bicepsProjection = [
  { contracte: 39, repos: 35 },
  { contracte: 39.2, repos: 35.2 },
  { contracte: 39.5, repos: 35.4 },
  { contracte: 39.8, repos: 35.7 },
  { contracte: 40.1, repos: 35.9 },
  { contracte: 40.5, repos: 36.1 },
  { contracte: 40.7, repos: 36.3 },
  { contracte: 41, repos: 36.5 },
  { contracte: 41.2, repos: 36.7 },
  { contracte: 41.3, repos: 36.8 },
  { contracte: 41.5, repos: 37 },
  { contracte: 41.75, repos: 37.1 },
];

// â”€â”€â”€ DEFAULT EXERCISES (PPL biceps focus) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const defaultExercises = [
  { id: "curl_barre", name: "Curl barre EZ", icon: "ğŸ‹ï¸" },
  { id: "curl_incline", name: "Curl haltÃ¨res inclinÃ©", icon: "ğŸ’ª" },
  { id: "curl_marteau", name: "Curl marteau", icon: "ğŸ”¨" },
  { id: "curl_pupitre", name: "Curl pupitre", icon: "ğŸ¯" },
  { id: "curl_cable", name: "Curl cÃ¢ble poulie basse", icon: "ğŸ”—" },
];

// â”€â”€â”€ STORAGE HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const STORAGE_KEY = "biceps-tracker-v2";

async function loadData() {
  try {
    const result = await window.storage.get(STORAGE_KEY);
    return result ? JSON.parse(result.value) : null;
  } catch {
    return null;
  }
}

async function saveData(data) {
  try {
    await window.storage.set(STORAGE_KEY, JSON.stringify(data));
  } catch (e) {
    console.error("Save failed:", e);
  }
}

function getEmptyWeekData() {
  const exercises = {};
  defaultExercises.forEach((ex) => {
    exercises[ex.id] = {
      sets: [
        { weight: "", reps: "", done: false },
        { weight: "", reps: "", done: false },
        { weight: "", reps: "", done: false },
        { weight: "", reps: "", done: false },
      ],
      targetWeight: "",
      targetReps: "",
    };
  });
  return {
    exercises,
    bicepsContracte: "",
    bicepsRepos: "",
    notes: "",
    bodyweight: "",
  };
}

function getDefaultState() {
  const weekData = {};
  for (let i = 1; i <= 12; i++) {
    weekData[i] = getEmptyWeekData();
  }
  return { weekData, currentWeek: 1 };
}

// â”€â”€â”€ MICRO COMPONENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function Pill({ children, color, active, onClick }) {
  return (
    <button
      onClick={onClick}
      style={{
        padding: "7px 14px",
        borderRadius: 20,
        border: active ? `2px solid ${color}` : "2px solid rgba(255,255,255,0.08)",
        background: active ? `${color}18` : "rgba(255,255,255,0.03)",
        color: active ? color : "rgba(255,255,255,0.45)",
        fontSize: 12,
        fontWeight: 600,
        cursor: "pointer",
        transition: "all 0.2s",
        fontFamily: "inherit",
        letterSpacing: 0.3,
      }}
    >
      {children}
    </button>
  );
}

function StatBox({ label, value, sub, color, small }) {
  return (
    <div
      style={{
        flex: small ? "0 0 auto" : 1,
        padding: small ? "10px 14px" : "14px 18px",
        borderRadius: 12,
        background: "rgba(255,255,255,0.03)",
        border: "1px solid rgba(255,255,255,0.06)",
      }}
    >
      <div style={{ fontSize: 10, color: "rgba(255,255,255,0.35)", fontWeight: 600, textTransform: "uppercase", letterSpacing: 1 }}>
        {label}
      </div>
      <div style={{ fontSize: small ? 18 : 22, fontWeight: 700, marginTop: 4, fontFamily: "'JetBrains Mono', monospace", color: color || "#fff" }}>
        {value}
      </div>
      {sub && <div style={{ fontSize: 11, color: "rgba(255,255,255,0.3)", marginTop: 2 }}>{sub}</div>}
    </div>
  );
}

function Delta({ current, previous, unit = "kg", better = "higher" }) {
  if (!current || !previous) return null;
  const diff = parseFloat(current) - parseFloat(previous);
  if (isNaN(diff) || diff === 0) return null;
  const isGood = better === "higher" ? diff > 0 : diff < 0;
  return (
    <span style={{ fontSize: 11, fontWeight: 700, color: isGood ? "#10B981" : "#EF4444", marginLeft: 6 }}>
      {diff > 0 ? "â–²" : "â–¼"} {Math.abs(diff).toFixed(1)}{unit}
    </span>
  );
}

function MiniBar({ value, max, color }) {
  const pct = max > 0 ? Math.min((value / max) * 100, 100) : 0;
  return (
    <div style={{ height: 4, background: "rgba(255,255,255,0.06)", borderRadius: 2, flex: 1 }}>
      <div style={{ height: "100%", width: `${pct}%`, background: color, borderRadius: 2, transition: "width 0.4s ease" }} />
    </div>
  );
}

function InputField({ value, onChange, placeholder, width = 60, align = "center" }) {
  return (
    <input
      type="text"
      inputMode="decimal"
      value={value}
      onChange={(e) => onChange(e.target.value)}
      placeholder={placeholder}
      style={{
        width,
        padding: "8px 8px",
        borderRadius: 8,
        border: "1px solid rgba(255,255,255,0.1)",
        background: "rgba(255,255,255,0.04)",
        color: "#fff",
        fontSize: 14,
        fontFamily: "'JetBrains Mono', monospace",
        fontWeight: 600,
        textAlign: align,
        outline: "none",
        transition: "border 0.2s",
      }}
      onFocus={(e) => (e.target.style.borderColor = "rgba(255,255,255,0.3)")}
      onBlur={(e) => (e.target.style.borderColor = "rgba(255,255,255,0.1)")}
    />
  );
}

function CheckDot({ checked, onToggle, color }) {
  return (
    <button
      onClick={onToggle}
      style={{
        width: 24,
        height: 24,
        borderRadius: "50%",
        border: `2px solid ${checked ? color : "rgba(255,255,255,0.15)"}`,
        background: checked ? color : "transparent",
        cursor: "pointer",
        display: "flex",
        alignItems: "center",
        justifyContent: "center",
        transition: "all 0.2s",
        padding: 0,
        flexShrink: 0,
      }}
    >
      {checked && (
        <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
          <path d="M2 6L5 9L10 3" stroke="#fff" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
        </svg>
      )}
    </button>
  );
}

// â”€â”€â”€ REST TIMER (floating overlay) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function RestTimer({ seconds, color, onDone, onCancel, onDurationChange }) {
  const [remaining, setRemaining] = useState(seconds);
  const [paused, setPaused] = useState(false);
  const total = useRef(seconds);
  const audioCtx = useRef(null);

  useEffect(() => {
    setRemaining(seconds);
    total.current = seconds;
  }, [seconds]);

  useEffect(() => {
    if (paused) return;
    if (remaining <= 0) {
      // Beep sound
      try {
        if (!audioCtx.current) audioCtx.current = new (window.AudioContext || window.webkitAudioContext)();
        const ctx = audioCtx.current;
        const playBeep = (delay) => {
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.connect(gain);
          gain.connect(ctx.destination);
          osc.frequency.value = 880;
          osc.type = "sine";
          gain.gain.value = 0.3;
          osc.start(ctx.currentTime + delay);
          osc.stop(ctx.currentTime + delay + 0.12);
        };
        playBeep(0);
        playBeep(0.2);
        playBeep(0.4);
      } catch {}
      // Vibrate if available
      try { navigator.vibrate?.([200, 100, 200, 100, 200]); } catch {}
      onDone();
      return;
    }
    const t = setTimeout(() => setRemaining((r) => r - 1), 1000);
    return () => clearTimeout(t);
  }, [remaining, paused, onDone]);

  const pct = total.current > 0 ? remaining / total.current : 0;
  const radius = 54;
  const circumference = 2 * Math.PI * radius;
  const offset = circumference * (1 - pct);
  const mins = Math.floor(remaining / 60);
  const secs = remaining % 60;
  const isLow = remaining <= 5 && remaining > 0;

  return (
    <div
      style={{
        position: "fixed",
        bottom: 0,
        left: 0,
        right: 0,
        zIndex: 9999,
        display: "flex",
        flexDirection: "column",
        alignItems: "center",
        padding: "20px 16px 28px",
        background: "linear-gradient(to top, rgba(8,8,13,0.98) 0%, rgba(8,8,13,0.92) 100%)",
        backdropFilter: "blur(20px)",
        WebkitBackdropFilter: "blur(20px)",
        borderTop: `1px solid ${color}30`,
        animation: "slideUp 0.3s ease-out",
      }}
    >
      <style>{`
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
      `}</style>

      <div style={{ fontSize: 10, fontWeight: 700, textTransform: "uppercase", letterSpacing: 2, color: "rgba(255,255,255,0.35)", marginBottom: 14 }}>
        â± Temps de repos
      </div>

      {/* Circular progress */}
      <div style={{ position: "relative", width: 130, height: 130, marginBottom: 16 }}>
        <svg width="130" height="130" viewBox="0 0 130 130" style={{ transform: "rotate(-90deg)" }}>
          <circle cx="65" cy="65" r={radius} fill="none" stroke="rgba(255,255,255,0.06)" strokeWidth="6" />
          <circle
            cx="65" cy="65" r={radius} fill="none"
            stroke={isLow ? "#EF4444" : color}
            strokeWidth="6"
            strokeLinecap="round"
            strokeDasharray={circumference}
            strokeDashoffset={offset}
            style={{ transition: "stroke-dashoffset 1s linear, stroke 0.3s" }}
          />
        </svg>
        <div style={{
          position: "absolute", inset: 0, display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center",
          animation: isLow ? "pulse 0.5s ease-in-out infinite" : "none",
        }}>
          <div style={{ fontFamily: "'JetBrains Mono', monospace", fontSize: 36, fontWeight: 700, color: isLow ? "#EF4444" : "#fff", letterSpacing: -1 }}>
            {mins}:{secs.toString().padStart(2, "0")}
          </div>
        </div>
      </div>

      {/* Preset buttons to adjust */}
      <div style={{ display: "flex", gap: 6, marginBottom: 14 }}>
        {REST_PRESETS.map((p) => (
          <button
            key={p}
            onClick={() => { setRemaining(p); total.current = p; onDurationChange?.(p); }}
            style={{
              padding: "6px 10px",
              borderRadius: 8,
              border: total.current === p ? `1px solid ${color}60` : "1px solid rgba(255,255,255,0.08)",
              background: total.current === p ? `${color}15` : "rgba(255,255,255,0.03)",
              color: total.current === p ? color : "rgba(255,255,255,0.4)",
              fontSize: 12,
              fontWeight: 600,
              fontFamily: "'JetBrains Mono', monospace",
              cursor: "pointer",
            }}
          >
            {p >= 60 ? `${p / 60 >= 1 ? Math.floor(p / 60) + ":" + (p % 60 === 0 ? "00" : p % 60 < 10 ? "0" + (p % 60) : p % 60) : p + "s"}` : p + "s"}
          </button>
        ))}
      </div>

      {/* Controls */}
      <div style={{ display: "flex", gap: 10 }}>
        <button
          onClick={() => setPaused((p) => !p)}
          style={{
            padding: "10px 24px",
            borderRadius: 10,
            border: "1px solid rgba(255,255,255,0.1)",
            background: "rgba(255,255,255,0.05)",
            color: "#fff",
            fontSize: 13,
            fontWeight: 600,
            cursor: "pointer",
            fontFamily: "inherit",
          }}
        >
          {paused ? "â–¶ Reprendre" : "â¸ Pause"}
        </button>
        <button
          onClick={onCancel}
          style={{
            padding: "10px 24px",
            borderRadius: 10,
            border: "1px solid rgba(255,255,255,0.06)",
            background: "rgba(255,255,255,0.02)",
            color: "rgba(255,255,255,0.4)",
            fontSize: 13,
            fontWeight: 600,
            cursor: "pointer",
            fontFamily: "inherit",
          }}
        >
          âœ• Passer
        </button>
      </div>
    </div>
  );
}

// â”€â”€â”€ EXERCISE CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function ExerciseCard({ exercise, data, prevData, color, onChange, onSetDone }) {
  const prevBestWeight = prevData
    ? Math.max(...prevData.sets.filter((s) => s.weight && s.done).map((s) => parseFloat(s.weight) || 0), 0)
    : 0;
  const prevBestReps = prevData
    ? Math.max(...prevData.sets.filter((s) => s.reps && s.done).map((s) => parseInt(s.reps) || 0), 0)
    : 0;
  const currBestWeight = Math.max(...data.sets.filter((s) => s.weight && s.done).map((s) => parseFloat(s.weight) || 0), 0);
  const setsCompleted = data.sets.filter((s) => s.done).length;

  const targetW = parseFloat(data.targetWeight) || 0;
  const targetR = parseInt(data.targetReps) || 0;

  return (
    <div
      style={{
        borderRadius: 16,
        background: "rgba(255,255,255,0.025)",
        border: "1px solid rgba(255,255,255,0.06)",
        overflow: "hidden",
        transition: "all 0.3s",
      }}
    >
      {/* Header */}
      <div style={{ padding: "14px 18px 12px", display: "flex", alignItems: "center", justifyContent: "space-between" }}>
        <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
          <span style={{ fontSize: 20 }}>{exercise.icon}</span>
          <div>
            <div style={{ fontSize: 14, fontWeight: 700, color: "#fff" }}>{exercise.name}</div>
            <div style={{ fontSize: 11, color: "rgba(255,255,255,0.35)", marginTop: 1 }}>
              {setsCompleted}/4 sÃ©ries
              {prevBestWeight > 0 && (
                <span style={{ marginLeft: 8, color: "rgba(255,255,255,0.25)" }}>
                  Sem. prÃ©c: {prevBestWeight}kg Ã— {prevBestReps}
                </span>
              )}
            </div>
          </div>
        </div>
        {/* Mini completion bar */}
        <div style={{ width: 60, display: "flex", alignItems: "center", gap: 6 }}>
          <MiniBar value={setsCompleted} max={4} color={color} />
          <span style={{ fontSize: 10, color: "rgba(255,255,255,0.3)", fontWeight: 600 }}>{setsCompleted * 25}%</span>
        </div>
      </div>

      {/* Targets row */}
      <div
        style={{
          padding: "10px 18px",
          background: `${color}08`,
          borderTop: `1px solid ${color}15`,
          borderBottom: `1px solid ${color}15`,
          display: "flex",
          alignItems: "center",
          gap: 16,
        }}
      >
        <span style={{ fontSize: 10, fontWeight: 700, textTransform: "uppercase", letterSpacing: 1, color: color, minWidth: 70 }}>
          ğŸ¯ Objectif
        </span>
        <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
          <InputField
            value={data.targetWeight}
            onChange={(v) => onChange("targetWeight", v)}
            placeholder="kg"
            width={52}
          />
          <span style={{ fontSize: 12, color: "rgba(255,255,255,0.3)" }}>kg</span>
        </div>
        <span style={{ color: "rgba(255,255,255,0.15)" }}>Ã—</span>
        <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
          <InputField
            value={data.targetReps}
            onChange={(v) => onChange("targetReps", v)}
            placeholder="reps"
            width={46}
          />
          <span style={{ fontSize: 12, color: "rgba(255,255,255,0.3)" }}>reps</span>
        </div>
        {prevBestWeight > 0 && targetW > 0 && (
          <Delta current={targetW} previous={prevBestWeight} unit="kg" />
        )}
      </div>

      {/* Sets */}
      <div style={{ padding: "10px 18px 14px" }}>
        <div style={{ display: "flex", gap: 8, marginBottom: 8, paddingLeft: 34 }}>
          <span style={{ width: 60, fontSize: 10, fontWeight: 600, textTransform: "uppercase", letterSpacing: 0.8, color: "rgba(255,255,255,0.25)", textAlign: "center" }}>
            Poids
          </span>
          <span style={{ width: 46, fontSize: 10, fontWeight: 600, textTransform: "uppercase", letterSpacing: 0.8, color: "rgba(255,255,255,0.25)", textAlign: "center" }}>
            Reps
          </span>
        </div>
        {data.sets.map((set, si) => {
          const w = parseFloat(set.weight) || 0;
          const r = parseInt(set.reps) || 0;
          const hitTarget = targetW > 0 && targetR > 0 && w >= targetW && r >= targetR && set.done;
          return (
            <div
              key={si}
              style={{
                display: "flex",
                alignItems: "center",
                gap: 8,
                marginBottom: 6,
                padding: "4px 0",
                opacity: set.done ? 1 : 0.7,
              }}
            >
              <CheckDot
                checked={set.done}
                onToggle={() => {
                  onChange(`set_${si}_done`, !set.done);
                  if (!set.done) onSetDone();
                }}
                color={hitTarget ? "#10B981" : color}
              />
              <InputField
                value={set.weight}
                onChange={(v) => onChange(`set_${si}_weight`, v)}
                placeholder="â€”"
                width={60}
              />
              <InputField
                value={set.reps}
                onChange={(v) => onChange(`set_${si}_reps`, v)}
                placeholder="â€”"
                width={46}
              />
              {set.done && hitTarget && (
                <span style={{ fontSize: 12, color: "#10B981", fontWeight: 700 }}>âœ“ Target</span>
              )}
              {set.done && w > 0 && !hitTarget && targetW > 0 && (
                <span style={{ fontSize: 11, color: "rgba(255,255,255,0.25)" }}>
                  {w < targetW ? `${(targetW - w).toFixed(1)}kg restant` : `${r}/${targetR} reps`}
                </span>
              )}
            </div>
          );
        })}
      </div>
    </div>
  );
}

// â”€â”€â”€ PREVIOUS WEEK RECAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function PrevWeekRecap({ prevWeekData, color }) {
  if (!prevWeekData) return null;

  const exerciseResults = defaultExercises.map((ex) => {
    const d = prevWeekData.exercises[ex.id];
    const doneSets = d.sets.filter((s) => s.done);
    const bestWeight = Math.max(...doneSets.map((s) => parseFloat(s.weight) || 0), 0);
    const bestReps = Math.max(...doneSets.filter((s) => parseFloat(s.weight) === bestWeight).map((s) => parseInt(s.reps) || 0), 0);
    return { ...ex, bestWeight, bestReps, setsCompleted: doneSets.length, total: d.sets.length };
  }).filter((r) => r.setsCompleted > 0);

  if (exerciseResults.length === 0) return null;

  return (
    <div
      style={{
        borderRadius: 14,
        background: "linear-gradient(135deg, rgba(255,255,255,0.04), rgba(255,255,255,0.015))",
        border: "1px solid rgba(255,255,255,0.08)",
        padding: "16px 18px",
        marginBottom: 16,
      }}
    >
      <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 14 }}>
        <span style={{ fontSize: 16 }}>ğŸ“Š</span>
        <span style={{ fontSize: 13, fontWeight: 700, textTransform: "uppercase", letterSpacing: 1, color: "rgba(255,255,255,0.5)" }}>
          RÃ©sultats semaine prÃ©cÃ©dente
        </span>
      </div>
      <div style={{ display: "flex", flexWrap: "wrap", gap: 8 }}>
        {exerciseResults.map((r) => (
          <div
            key={r.id}
            style={{
              padding: "10px 14px",
              borderRadius: 10,
              background: "rgba(255,255,255,0.03)",
              border: "1px solid rgba(255,255,255,0.06)",
              minWidth: 140,
              flex: "1 1 140px",
            }}
          >
            <div style={{ fontSize: 11, color: "rgba(255,255,255,0.4)", fontWeight: 600, marginBottom: 4 }}>
              {r.icon} {r.name}
            </div>
            <div style={{ fontFamily: "'JetBrains Mono', monospace", fontSize: 16, fontWeight: 700 }}>
              {r.bestWeight}<span style={{ fontSize: 11, color: "rgba(255,255,255,0.35)", fontWeight: 500 }}>kg</span>
              <span style={{ color: "rgba(255,255,255,0.2)", margin: "0 4px" }}>Ã—</span>
              {r.bestReps}<span style={{ fontSize: 11, color: "rgba(255,255,255,0.35)", fontWeight: 500 }}>reps</span>
            </div>
            <div style={{ fontSize: 10, color: "rgba(255,255,255,0.25)", marginTop: 3 }}>
              {r.setsCompleted}/{r.total} sÃ©ries complÃ©tÃ©es
            </div>
          </div>
        ))}
      </div>
      {prevWeekData.bicepsContracte && (
        <div style={{ marginTop: 12, display: "flex", gap: 12 }}>
          <div style={{ fontSize: 12, color: "rgba(255,255,255,0.4)" }}>
            Biceps contractÃ©: <span style={{ color: color, fontWeight: 700 }}>{prevWeekData.bicepsContracte} cm</span>
          </div>
          {prevWeekData.bicepsRepos && (
            <div style={{ fontSize: 12, color: "rgba(255,255,255,0.4)" }}>
              Repos: <span style={{ color: "rgba(255,255,255,0.6)", fontWeight: 700 }}>{prevWeekData.bicepsRepos} cm</span>
            </div>
          )}
        </div>
      )}
    </div>
  );
}

// â”€â”€â”€ WEEK PROGRESS SUMMARY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function WeekProgress({ weekData, color }) {
  const totalSets = defaultExercises.length * 4;
  const doneSets = defaultExercises.reduce((acc, ex) => {
    return acc + weekData.exercises[ex.id].sets.filter((s) => s.done).length;
  }, 0);
  const targetsHit = defaultExercises.reduce((acc, ex) => {
    const d = weekData.exercises[ex.id];
    const tw = parseFloat(d.targetWeight) || 0;
    const tr = parseInt(d.targetReps) || 0;
    if (tw === 0 || tr === 0) return acc;
    const hits = d.sets.filter((s) => s.done && (parseFloat(s.weight) || 0) >= tw && (parseInt(s.reps) || 0) >= tr).length;
    return acc + (hits > 0 ? 1 : 0);
  }, 0);
  const targetsSet = defaultExercises.filter((ex) => {
    const d = weekData.exercises[ex.id];
    return (parseFloat(d.targetWeight) || 0) > 0 && (parseInt(d.targetReps) || 0) > 0;
  }).length;

  return (
    <div style={{ display: "flex", gap: 10, marginBottom: 16, flexWrap: "wrap" }}>
      <StatBox label="SÃ©ries complÃ©tÃ©es" value={`${doneSets}/${totalSets}`} color={doneSets === totalSets ? "#10B981" : "#fff"} />
      <StatBox label="Objectifs atteints" value={targetsSet > 0 ? `${targetsHit}/${targetsSet}` : "â€”"} color={targetsHit === targetsSet && targetsSet > 0 ? "#10B981" : "#fff"} />
      <StatBox label="ComplÃ©tion" value={`${Math.round((doneSets / totalSets) * 100)}%`} color={color} />
    </div>
  );
}

// â”€â”€â”€ BICEPS CHART (mini sparkline) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function BicepsSparkline({ allWeekData, currentWeek }) {
  const w = 320;
  const h = 80;
  const pad = { l: 30, r: 10, t: 10, b: 20 };
  const iw = w - pad.l - pad.r;
  const ih = h - pad.t - pad.b;

  const projPoints = bicepsProjection.map((p, i) => ({
    x: pad.l + (i / 11) * iw,
    y: pad.t + ih - ((p.contracte - 38.5) / 4) * ih,
  }));

  const realPoints = [];
  for (let i = 0; i < 12; i++) {
    const wd = allWeekData[i + 1];
    if (wd && wd.bicepsContracte) {
      const v = parseFloat(wd.bicepsContracte);
      if (!isNaN(v)) {
        realPoints.push({
          x: pad.l + (i / 11) * iw,
          y: pad.t + ih - ((v - 38.5) / 4) * ih,
          v,
        });
      }
    }
  }

  const projPath = projPoints.map((p, i) => `${i === 0 ? "M" : "L"}${p.x},${p.y}`).join(" ");
  const realPath = realPoints.length > 1
    ? realPoints.map((p, i) => `${i === 0 ? "M" : "L"}${p.x},${p.y}`).join(" ")
    : null;

  return (
    <svg width={w} height={h} style={{ display: "block" }}>
      {/* Grid lines */}
      {[39, 40, 41, 42].map((v) => {
        const y = pad.t + ih - ((v - 38.5) / 4) * ih;
        return (
          <g key={v}>
            <line x1={pad.l} x2={w - pad.r} y1={y} y2={y} stroke="rgba(255,255,255,0.06)" strokeDasharray="2,4" />
            <text x={pad.l - 4} y={y + 3} fill="rgba(255,255,255,0.2)" fontSize="8" textAnchor="end" fontFamily="monospace">{v}</text>
          </g>
        );
      })}
      {/* Week labels */}
      {[1, 4, 8, 12].map((wk) => {
        const x = pad.l + ((wk - 1) / 11) * iw;
        return <text key={wk} x={x} y={h - 4} fill="rgba(255,255,255,0.2)" fontSize="8" textAnchor="middle" fontFamily="monospace">S{wk}</text>;
      })}
      {/* Projection line */}
      <path d={projPath} fill="none" stroke="rgba(255,255,255,0.15)" strokeWidth="1.5" strokeDasharray="4,3" />
      {/* Real data line */}
      {realPath && <path d={realPath} fill="none" stroke="#10B981" strokeWidth="2" />}
      {realPoints.map((p, i) => (
        <circle key={i} cx={p.x} cy={p.y} r={3} fill="#10B981" />
      ))}
      {/* Current week indicator */}
      <line
        x1={pad.l + ((currentWeek - 1) / 11) * iw}
        x2={pad.l + ((currentWeek - 1) / 11) * iw}
        y1={pad.t}
        y2={pad.t + ih}
        stroke="rgba(255,255,255,0.1)"
        strokeWidth="1"
      />
    </svg>
  );
}

// â”€â”€â”€ MAIN APP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
export default function EvolutionTracker() {
  const [state, setState] = useState(null);
  const [activeWeek, setActiveWeek] = useState(0);
  const [tab, setTab] = useState("track"); // "track" | "evolution"
  const [saving, setSaving] = useState(false);
  const [timerActive, setTimerActive] = useState(false);
  const [restDuration, setRestDuration] = useState(90);

  // Keep screen awake when on track tab
  useWakeLock(tab === "track");

  // Load on mount
  useEffect(() => {
    loadData().then((saved) => {
      if (saved && saved.weekData) {
        // Merge with defaults to handle new exercises
        const merged = getDefaultState();
        Object.keys(saved.weekData).forEach((wk) => {
          if (merged.weekData[wk]) {
            merged.weekData[wk] = { ...merged.weekData[wk], ...saved.weekData[wk] };
            // Ensure all exercises exist
            defaultExercises.forEach((ex) => {
              if (!merged.weekData[wk].exercises[ex.id]) {
                merged.weekData[wk].exercises[ex.id] = getEmptyWeekData().exercises[ex.id];
              }
            });
          }
        });
        merged.currentWeek = saved.currentWeek || 1;
        setState(merged);
        setActiveWeek(merged.currentWeek - 1);
      } else {
        setState(getDefaultState());
      }
    });
  }, []);

  // Auto-save
  const doSave = useCallback(async (s) => {
    setSaving(true);
    await saveData(s);
    setTimeout(() => setSaving(false), 500);
  }, []);

  useEffect(() => {
    if (state) {
      const t = setTimeout(() => doSave(state), 800);
      return () => clearTimeout(t);
    }
  }, [state, doSave]);

  if (!state) {
    return (
      <div style={{ minHeight: "100vh", background: "#08080d", display: "flex", alignItems: "center", justifyContent: "center", color: "#fff" }}>
        <div style={{ fontSize: 14, color: "rgba(255,255,255,0.4)" }}>Chargement...</div>
      </div>
    );
  }

  const weekIdx = activeWeek;
  const weekNum = weekIdx + 1;
  const phase = phases[weekIdx];
  const weekData = state.weekData[weekNum];
  const prevWeekData = weekNum > 1 ? state.weekData[weekNum - 1] : null;
  const proj = bicepsProjection[weekIdx];

  function updateExercise(exId, field, value) {
    setState((prev) => {
      const next = JSON.parse(JSON.stringify(prev));
      const ex = next.weekData[weekNum].exercises[exId];
      if (field === "targetWeight" || field === "targetReps") {
        ex[field] = value;
      } else if (field.startsWith("set_")) {
        const parts = field.split("_");
        const si = parseInt(parts[1]);
        const prop = parts[2];
        ex.sets[si][prop] = value;
      }
      return next;
    });
  }

  function updateWeekField(field, value) {
    setState((prev) => {
      const next = JSON.parse(JSON.stringify(prev));
      next.weekData[weekNum][field] = value;
      return next;
    });
  }

  // â”€â”€â”€ Evolution data (reuse from original) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const evolutionData = [
    { keyMoment: "Premier vrai pump satisfaisant", silhouette: "Quasi identique â€” le changement est interne. Tes sÃ©ances vont devenir plus fluides.", changes: ["Pump post-sÃ©ance plus prononcÃ©", "Muscles plus gonflÃ©s au rÃ©veil", "Veines des avant-bras plus apparentes"], zones: { epaules: 1, dos: 1, bras: 1, abdos: 0, jambes: 1 } },
    { keyMoment: "Premier compliment 'tu fais de la muscu ?'", silhouette: "Les gens proches peuvent remarquer que tu as l'air plus large.", changes: ["DeltoÃ¯des lÃ©gÃ¨rement plus ronds", "Haut du dos plus plein en T-shirt", "RÃ©tention d'eau musculaire visible"], zones: { epaules: 2, dos: 2, bras: 1, abdos: 0, jambes: 1 } },
    { keyMoment: "Tes anciens T-shirts serrent aux Ã©paules", silhouette: "De face, tes Ã©paules commencent Ã  dÃ©border. L'Ã©bauche du V-taper se devine.", changes: ["TrapÃ¨zes visiblement plus Ã©pais", "Bras plus tendus dans les manches", "DÃ©but de tonus pectoral"], zones: { epaules: 2, dos: 2, bras: 2, abdos: 0, jambes: 1 } },
    { keyMoment: "ğŸ“¸ Premier avant/aprÃ¨s convaincant", silhouette: "Premier vrai changement visible sur photos. Le haut du corps a clairement changÃ©.", changes: ["V-taper perceptible de face", "DeltoÃ¯des commencent Ã  capper", "Dorsaux plus larges", "Veines permanentes avant-bras"], zones: { epaules: 3, dos: 3, bras: 2, abdos: 0, jambes: 2 } },
    { keyMoment: "La sÃ©paration deltoÃ¯de/biceps apparaÃ®t", silhouette: "MÃªme sans pump, tu parais athlÃ©tique. Le ratio Ã©paules/taille s'amÃ©liore.", changes: ["SÃ©paration deltoÃ¯de/bras visible", "Pectoraux prennent du volume", "Quadriceps plus dessinÃ©s", "Cou plus Ã©pais"], zones: { epaules: 3, dos: 3, bras: 3, abdos: 1, jambes: 2 } },
    { keyMoment: "Les inconnus te demandent ton programme", silhouette: "Tu as l'air d'un gars qui s'entraÃ®ne sÃ©rieusement, pas juste en forme.", changes: ["V-taper net mÃªme en T-shirt ample", "Triceps plus dÃ©coupÃ©s", "Ligne mÃ©diane abdominale", "Avant-bras vasculaires"], zones: { epaules: 4, dos: 4, bras: 3, abdos: 1, jambes: 2 } },
    { keyMoment: "Le dos commence Ã  parler en photo", silhouette: "Phase de remplissage â€” les muscles prennent de la densitÃ© et de la qualitÃ©.", changes: ["Dorsaux crÃ©ent un vrai flare", "Pectoraux se sÃ©parent du deltoÃ¯de", "Fessiers plus proÃ©minents", "Avant-bras rattrapent"], zones: { epaules: 4, dos: 4, bras: 3, abdos: 1, jambes: 3 } },
    { keyMoment: "ğŸ“¸ Transformation claire sur photos", silhouette: "Le physique a une vraie prÃ©sence. Ã€ 1m96, tu remplis une piÃ¨ce.", changes: ["SÃ©paration Ã©paule/bras au repos", "Stries pectorales visibles", "Tour de cou +1.5 cm", "Mollets proportionnels"], zones: { epaules: 4, dos: 4, bras: 4, abdos: 1, jambes: 3 } },
    { keyMoment: "Les abdos supÃ©rieurs pointent", silhouette: "En T-shirt ajustÃ©, physique clairement musclÃ© et athlÃ©tique.", changes: ["V-taper prononcÃ©", "Biceps peak en flexion", "Abdos supÃ©rieurs se dessinent", "TrapÃ¨zes imposants"], zones: { epaules: 5, dos: 5, bras: 4, abdos: 2, jambes: 3 } },
    { keyMoment: "Les veines des bras sont permanentes", silhouette: "La dÃ©finition se superpose au volume. Phase la plus gratifiante.", changes: ["SÃ©paration triceps 3 chefs", "Christmas tree bas du dos", "Veines bicipitales permanentes", "Quadriceps sweep visible"], zones: { epaules: 5, dos: 5, bras: 4, abdos: 2, jambes: 4 } },
    { keyMoment: "Le physique tourne les tÃªtes Ã  la salle", silhouette: "Physique d'athlÃ¨te qui force le respect.", changes: ["Stries deltoÃ¯des visibles", "Ligne abdominale nette", "Avant-bras Ã©paissis par farmer's walk", "Obliques dÃ©coupÃ©s"], zones: { epaules: 5, dos: 5, bras: 5, abdos: 2, jambes: 4 } },
    { keyMoment: "ğŸ† Photo finale â€” mÃ©connaissable", silhouette: "Transformation complÃ¨te. Ã€ 1m96, physique qui impressionne mÃªme habillÃ©.", changes: ["V-taper imposant", "SÃ©paration musculaire haut du corps", "4 abdos supÃ©rieurs visibles", "Look de puissance installÃ©"], zones: { epaules: 5, dos: 5, bras: 5, abdos: 3, jambes: 4 } },
  ];
  const evo = evolutionData[weekIdx];
  const zoneLabels = { epaules: "Ã‰paules", dos: "Dos", bras: "Bras", abdos: "Abdos", jambes: "Jambes" };

  return (
    <div
      style={{
        minHeight: "100vh",
        background: "#08080d",
        color: "#fff",
        fontFamily: "'DM Sans', 'Segoe UI', sans-serif",
        padding: "20px 14px 40px",
      }}
    >
      <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet" />

      {/* â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
      <div style={{ textAlign: "center", marginBottom: 20, position: "relative" }}>
        <div style={{ display: "inline-block", padding: "4px 14px", borderRadius: 20, background: "rgba(255,255,255,0.05)", fontSize: 10, fontWeight: 700, letterSpacing: 2, textTransform: "uppercase", color: "rgba(255,255,255,0.4)", marginBottom: 8 }}>
          Projection 12 semaines Â· DÃ©but 29 janvier 2026
        </div>
        <h1 style={{ fontSize: 24, fontWeight: 800, margin: 0, letterSpacing: -0.5, background: "linear-gradient(135deg, #fff 0%, rgba(255,255,255,0.5) 100%)", WebkitBackgroundClip: "text", WebkitTextFillColor: "transparent" }}>
          Ã‰volution & Suivi
        </h1>
        <p style={{ fontSize: 12, color: "rgba(255,255,255,0.3)", margin: "4px 0 0" }}>
          1m96 Â· 95 kg Â· 38 ans Â· 4000 kcal Â· PPL 6Ã—/sem
        </p>
        {saving && (
          <div style={{ position: "absolute", top: 4, right: 10, fontSize: 10, color: "#10B981", fontWeight: 600, display: "flex", alignItems: "center", gap: 4 }}>
            <div style={{ width: 5, height: 5, borderRadius: "50%", background: "#10B981" }} /> SauvegardÃ©
          </div>
        )}
      </div>

      {/* â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
      <div style={{ display: "flex", justifyContent: "center", gap: 8, marginBottom: 20 }}>
        <Pill color="#fff" active={tab === "track"} onClick={() => setTab("track")}>
          ğŸ¯ Suivi & Objectifs
        </Pill>
        <Pill color="#fff" active={tab === "evolution"} onClick={() => setTab("evolution")}>
          ğŸ“ˆ Ã‰volution Physique
        </Pill>
      </div>

      {/* â”€â”€ WEEK SELECTOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
      <div style={{ display: "flex", gap: 5, justifyContent: "center", marginBottom: 20, flexWrap: "wrap" }}>
        {phases.map((p, i) => (
          <button
            key={i}
            onClick={() => setActiveWeek(i)}
            style={{
              width: 42,
              height: 42,
              borderRadius: 10,
              border: activeWeek === i ? `2px solid ${p.color}` : "2px solid rgba(255,255,255,0.06)",
              background: activeWeek === i ? `${p.color}20` : "rgba(255,255,255,0.02)",
              color: activeWeek === i ? "#fff" : "rgba(255,255,255,0.35)",
              fontSize: 12,
              fontWeight: 700,
              fontFamily: "'JetBrains Mono', monospace",
              cursor: "pointer",
              transition: "all 0.2s",
              position: "relative",
            }}
          >
            S{p.week}
            {/* Dot if data exists */}
            {state.weekData[p.week] && defaultExercises.some((ex) => state.weekData[p.week].exercises[ex.id]?.sets.some((s) => s.done)) && (
              <div style={{ position: "absolute", bottom: 2, left: "50%", transform: "translateX(-50%)", width: 4, height: 4, borderRadius: "50%", background: p.color }} />
            )}
          </button>
        ))}
      </div>

      {/* â”€â”€ PHASE BADGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
      <div style={{ display: "flex", alignItems: "center", justifyContent: "center", gap: 10, marginBottom: 20 }}>
        <div style={{ padding: "5px 14px", borderRadius: 8, background: phase.color, fontSize: 12, fontWeight: 700 }}>
          SEMAINE {weekNum}
        </div>
        <span style={{ fontSize: 13, fontWeight: 600, color: "rgba(255,255,255,0.5)" }}>{phase.phase}</span>
        <span style={{ fontSize: 12, color: "rgba(255,255,255,0.25)" }}>{phase.date}</span>
      </div>

      <div style={{ maxWidth: 700, margin: "0 auto" }}>
        {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
        {/* â”€â”€ TRACK TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
        {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
        {tab === "track" && (
          <>
            {/* Previous week recap */}
            <PrevWeekRecap prevWeekData={prevWeekData} color={phase.color} />

            {/* Week progress summary */}
            <WeekProgress weekData={weekData} color={phase.color} />

            {/* Biceps measurements */}
            <div style={{ borderRadius: 14, background: "rgba(255,255,255,0.025)", border: "1px solid rgba(255,255,255,0.06)", padding: "16px 18px", marginBottom: 16 }}>
              <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 14 }}>
                <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                  <span style={{ fontSize: 16 }}>ğŸ“</span>
                  <span style={{ fontSize: 13, fontWeight: 700, textTransform: "uppercase", letterSpacing: 1, color: "rgba(255,255,255,0.5)" }}>
                    Mesures biceps (jeudi)
                  </span>
                </div>
                <div style={{ fontSize: 11, color: "rgba(255,255,255,0.25)" }}>
                  Objectif: {proj.contracte} cm contractÃ©
                </div>
              </div>
              <div style={{ display: "flex", gap: 12, flexWrap: "wrap" }}>
                <div style={{ flex: 1, minWidth: 140 }}>
                  <div style={{ fontSize: 10, color: "rgba(255,255,255,0.3)", fontWeight: 600, textTransform: "uppercase", letterSpacing: 0.8, marginBottom: 6 }}>ContractÃ©</div>
                  <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                    <InputField value={weekData.bicepsContracte} onChange={(v) => updateWeekField("bicepsContracte", v)} placeholder={`${proj.contracte}`} width={70} />
                    <span style={{ fontSize: 12, color: "rgba(255,255,255,0.3)" }}>cm</span>
                    {prevWeekData?.bicepsContracte && weekData.bicepsContracte && (
                      <Delta current={weekData.bicepsContracte} previous={prevWeekData.bicepsContracte} unit="cm" />
                    )}
                  </div>
                </div>
                <div style={{ flex: 1, minWidth: 140 }}>
                  <div style={{ fontSize: 10, color: "rgba(255,255,255,0.3)", fontWeight: 600, textTransform: "uppercase", letterSpacing: 0.8, marginBottom: 6 }}>Au repos</div>
                  <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                    <InputField value={weekData.bicepsRepos} onChange={(v) => updateWeekField("bicepsRepos", v)} placeholder={`${proj.repos}`} width={70} />
                    <span style={{ fontSize: 12, color: "rgba(255,255,255,0.3)" }}>cm</span>
                    {prevWeekData?.bicepsRepos && weekData.bicepsRepos && (
                      <Delta current={weekData.bicepsRepos} previous={prevWeekData.bicepsRepos} unit="cm" />
                    )}
                  </div>
                </div>
                <div style={{ flex: 1, minWidth: 140 }}>
                  <div style={{ fontSize: 10, color: "rgba(255,255,255,0.3)", fontWeight: 600, textTransform: "uppercase", letterSpacing: 0.8, marginBottom: 6 }}>Poids corps</div>
                  <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                    <InputField value={weekData.bodyweight} onChange={(v) => updateWeekField("bodyweight", v)} placeholder="95" width={60} />
                    <span style={{ fontSize: 12, color: "rgba(255,255,255,0.3)" }}>kg</span>
                  </div>
                </div>
              </div>
              {/* Mini sparkline */}
              <div style={{ marginTop: 14, borderTop: "1px solid rgba(255,255,255,0.04)", paddingTop: 12 }}>
                <div style={{ fontSize: 10, color: "rgba(255,255,255,0.25)", marginBottom: 6 }}>
                  Progression biceps contractÃ© â€” <span style={{ color: "rgba(255,255,255,0.15)" }}>- - -</span> projection &nbsp; <span style={{ color: "#10B981" }}>â€”</span> rÃ©el
                </div>
                <BicepsSparkline allWeekData={state.weekData} currentWeek={weekNum} />
              </div>
            </div>

            {/* Rest timer setting */}
            <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 12, padding: "10px 16px", borderRadius: 12, background: "rgba(255,255,255,0.02)", border: "1px solid rgba(255,255,255,0.04)" }}>
              <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                <span style={{ fontSize: 14 }}>â±</span>
                <span style={{ fontSize: 12, color: "rgba(255,255,255,0.4)", fontWeight: 600 }}>Pause entre sÃ©ries</span>
              </div>
              <div style={{ display: "flex", gap: 4 }}>
                {REST_PRESETS.map((p) => (
                  <button
                    key={p}
                    onClick={() => setRestDuration(p)}
                    style={{
                      padding: "4px 8px",
                      borderRadius: 6,
                      border: restDuration === p ? `1px solid ${phase.color}50` : "1px solid rgba(255,255,255,0.06)",
                      background: restDuration === p ? `${phase.color}15` : "transparent",
                      color: restDuration === p ? phase.color : "rgba(255,255,255,0.3)",
                      fontSize: 11,
                      fontWeight: 600,
                      fontFamily: "'JetBrains Mono', monospace",
                      cursor: "pointer",
                    }}
                  >
                    {Math.floor(p / 60)}:{(p % 60).toString().padStart(2, "0")}
                  </button>
                ))}
              </div>
            </div>

            {/* Exercise cards */}
            <div style={{ display: "flex", flexDirection: "column", gap: 12, paddingBottom: timerActive ? 260 : 0, transition: "padding 0.3s" }}>
              {defaultExercises.map((ex) => (
                <ExerciseCard
                  key={ex.id}
                  exercise={ex}
                  data={weekData.exercises[ex.id]}
                  prevData={prevWeekData?.exercises[ex.id]}
                  color={phase.color}
                  onChange={(field, value) => updateExercise(ex.id, field, value)}
                  onSetDone={() => setTimerActive(true)}
                />
              ))}
            </div>

            {/* Notes */}
            <div style={{ marginTop: 16, borderRadius: 14, background: "rgba(255,255,255,0.025)", border: "1px solid rgba(255,255,255,0.06)", padding: "16px 18px" }}>
              <div style={{ fontSize: 10, color: "rgba(255,255,255,0.3)", fontWeight: 600, textTransform: "uppercase", letterSpacing: 1, marginBottom: 8 }}>
                ğŸ“ Notes / Ressenti de la semaine
              </div>
              <textarea
                value={weekData.notes}
                onChange={(e) => updateWeekField("notes", e.target.value)}
                placeholder="Comment tu t'es senti cette semaine ? Sommeil, Ã©nergie, pump..."
                rows={3}
                style={{
                  width: "100%",
                  padding: "10px 12px",
                  borderRadius: 10,
                  border: "1px solid rgba(255,255,255,0.08)",
                  background: "rgba(255,255,255,0.03)",
                  color: "#fff",
                  fontSize: 13,
                  fontFamily: "inherit",
                  lineHeight: 1.5,
                  resize: "vertical",
                  outline: "none",
                  boxSizing: "border-box",
                }}
              />
            </div>
          </>
        )}

        {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
        {/* â”€â”€ EVOLUTION TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
        {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
        {tab === "evolution" && (
          <>
            {/* Key moment */}
            <div style={{ padding: "14px 18px", borderRadius: 14, background: `${phase.color}0a`, border: `1px solid ${phase.color}25`, marginBottom: 16, display: "flex", alignItems: "center", gap: 10 }}>
              <span style={{ fontSize: 20 }}>ğŸ¯</span>
              <div>
                <div style={{ fontSize: 10, color: "rgba(255,255,255,0.35)", fontWeight: 600, textTransform: "uppercase", letterSpacing: 1 }}>Moment clÃ©</div>
                <div style={{ fontSize: 14, fontWeight: 700, color: "#fff", marginTop: 2 }}>{evo.keyMoment}</div>
              </div>
            </div>

            {/* Silhouette */}
            <div style={{ padding: "16px 18px", borderRadius: 14, background: "rgba(255,255,255,0.025)", border: "1px solid rgba(255,255,255,0.06)", marginBottom: 16 }}>
              <div style={{ fontSize: 10, color: "rgba(255,255,255,0.3)", fontWeight: 600, textTransform: "uppercase", letterSpacing: 1, marginBottom: 8 }}>ğŸª Ce que tu verras dans le miroir</div>
              <p style={{ fontSize: 14, lineHeight: 1.65, color: "rgba(255,255,255,0.75)", margin: 0 }}>{evo.silhouette}</p>
            </div>

            {/* Changements visibles */}
            <div style={{ padding: "16px 18px", borderRadius: 14, background: "rgba(255,255,255,0.025)", border: "1px solid rgba(255,255,255,0.06)", marginBottom: 16 }}>
              <div style={{ fontSize: 10, color: "rgba(255,255,255,0.3)", fontWeight: 600, textTransform: "uppercase", letterSpacing: 1, marginBottom: 12 }}>Changements visibles</div>
              {evo.changes.map((c, i) => (
                <div key={i} style={{ display: "flex", alignItems: "flex-start", gap: 10, padding: "7px 0", borderBottom: i < evo.changes.length - 1 ? "1px solid rgba(255,255,255,0.04)" : "none" }}>
                  <div style={{ minWidth: 6, height: 6, borderRadius: "50%", background: phase.color, marginTop: 6 }} />
                  <span style={{ fontSize: 13, lineHeight: 1.5, color: "rgba(255,255,255,0.7)" }}>{c}</span>
                </div>
              ))}
            </div>

            {/* Zone progress */}
            <div style={{ padding: "16px 18px", borderRadius: 14, background: "rgba(255,255,255,0.025)", border: "1px solid rgba(255,255,255,0.06)" }}>
              <div style={{ fontSize: 10, color: "rgba(255,255,255,0.3)", fontWeight: 600, textTransform: "uppercase", letterSpacing: 1, marginBottom: 14 }}>Progression par zone musculaire</div>
              {Object.entries(evo.zones).map(([key, val]) => (
                <div key={key} style={{ display: "flex", alignItems: "center", justifyContent: "space-between", padding: "8px 0" }}>
                  <span style={{ fontSize: 13, color: "rgba(255,255,255,0.55)", fontWeight: 500, minWidth: 70 }}>{zoneLabels[key]}</span>
                  <div style={{ display: "flex", gap: 4 }}>
                    {Array.from({ length: 5 }).map((_, i) => (
                      <div key={i} style={{ width: 10, height: 10, borderRadius: "50%", background: i < val ? phase.color : "rgba(255,255,255,0.08)", transition: "background 0.3s" }} />
                    ))}
                  </div>
                </div>
              ))}
            </div>
          </>
        )}
      </div>

      {/* â”€â”€ FOOTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
      <div style={{ textAlign: "center", marginTop: 30, maxWidth: 500, margin: "30px auto 0" }}>
        <p style={{ fontSize: 10, color: "rgba(255,255,255,0.2)", lineHeight: 1.5, margin: 0 }}>
          DonnÃ©es sauvegardÃ©es automatiquement Â· Ã‰cran maintenu actif en mode suivi Â· Projection basÃ©e sur mÃ©moire musculaire, 4000 kcal/j, PPL 6Ã—/sem
        </p>
      </div>

      {/* â”€â”€ REST TIMER OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
      {timerActive && (
        <RestTimer
          seconds={restDuration}
          color={phase.color}
          onDone={() => setTimerActive(false)}
          onCancel={() => setTimerActive(false)}
          onDurationChange={(d) => setRestDuration(d)}
        />
      )}
    </div>
  );
}
